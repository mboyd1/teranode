name: nightly-test-runs
on:
  schedule:
    - cron: '0 2 * * *'  # Runs at 2:00 AM UTC every day
  workflow_dispatch:

env:
  REPO: teranode
  SETTINGS_CONTEXT_DEFAULT: default_context
  GO_VERSION: '1.25.2'
  TEST_DIR: ./test/e2e/daemon/ready

permissions:
  contents: read
  pull-requests: read
  id-token: write
  packages: write

jobs:
  # Chain Integrity Test with 3 block generators
  chainintegrity:
    name: Chain Integrity Test
    runs-on: teranode-runner-16-core
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and load Docker image locally
        uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75 # v6
        with:
          context: .
          load: true
          tags: teranode:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Remove old data and recreate directories
        run: |
          rm -rf data
          mkdir -p data/postgres

      - name: Start Teranode nodes with 3 block generators (docker compose up)
        run: docker compose -f compose/docker-compose-3blasters.yml up -d

      - name: Wait for mining to complete (all nodes at height 120+ and in sync)
        run: |
          set -e
          REQUIRED_HEIGHT=120
          MAX_ATTEMPTS=120  # 10 minutes with 5s sleep
          SLEEP=5

          # Function to check for errors in all teranode container logs at once
          check_errors() {
            # Get current time for this check
            local current_time
            current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            # Check for errors - if last_check_time is empty, it will check all logs
            local since_param=""
            if [ ! -z "$last_check_time" ]; then
              since_param="--since=$last_check_time"
            fi

            # Single command pattern that works for both initial and subsequent checks
            local errors
            errors=$(docker compose -f compose/docker-compose-3blasters.yml logs --no-color $since_param teranode1 teranode2 teranode3 | grep -i "| ERROR |" || true)

            # Update timestamp for next check
            last_check_time=$current_time

            if [[ ! -z "$errors" ]]; then
              echo "ERROR: Found error logs in teranode containers:"
              echo "$errors"
              return 1
            fi
            return 0
          }

          # Initialize empty for first check to get all logs
          last_check_time=""

          for ((i=1; i<=MAX_ATTEMPTS; i++)); do
            h1=$(curl -s http://localhost:18090/api/v1/bestblockheader/json | jq -r .height)
            h2=$(curl -s http://localhost:28090/api/v1/bestblockheader/json | jq -r .height)
            h3=$(curl -s http://localhost:38090/api/v1/bestblockheader/json | jq -r .height)
            echo "Attempt $i: heights: $h1 $h2 $h3"

            # Check for errors in all teranode containers
            if ! check_errors; then
              echo "Errors found in container logs. Exiting."
              exit 1
            fi

            if [[ -z "$h1" || -z "$h2" || -z "$h3" ]]; then
              if [[ $i -gt 10 ]]; then
                echo "Error: One or more nodes are not responding after 10 attempts. Exiting."
                exit 1
              else
                echo "Warning: One or more nodes are not responding. Continuing..."
              fi
            fi
            if [[ "$h1" =~ ^[0-9]+$ && "$h2" =~ ^[0-9]+$ && "$h3" =~ ^[0-9]+$ ]]; then
              if [[ $h1 -ge $REQUIRED_HEIGHT && $h2 -ge $REQUIRED_HEIGHT && $h3 -ge $REQUIRED_HEIGHT ]]; then
                echo "All nodes have reached height $REQUIRED_HEIGHT or greater."
                exit 0
              fi
            fi
            sleep $SLEEP
          done
          echo "Timeout waiting for all nodes to reach height $REQUIRED_HEIGHT."
          exit 1

      - name: Collect Docker container logs
        if: failure()
        run: |
          mkdir -p container-logs
          containers=$(docker ps -a --format "{{.Names}}")
          for container in $containers; do
            echo "Collecting logs for container: $container"
            docker logs "$container" > "container-logs/$container.log" 2>&1 || true
          done

      - name: Upload container logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: container-logs
          path: container-logs/

      - name: Stop Teranode nodes (docker compose down for teranode-1/2/3)
        run: docker compose -f compose/docker-compose-3blasters.yml down teranode1 teranode2 teranode3

      - name: Build chainintegrity binary
        run: make build-chainintegrity

      - name: Run chainintegrity test
        run: ./chainintegrity.run --logfile=chainintegrity --debug | tee chainintegrity_output.log

      - name: Check for hash mismatch and fail if found
        run: |
          if grep -q "All filtered log file hashes differ! No majority consensus among nodes." chainintegrity_output.log; then
            echo "Chain integrity test failed: all log file hashes differ, no majority consensus."
            exit 1
          fi

      - name: Upload chainintegrity logs
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: chainintegrity-logs
          path: |
            chainintegrity*.log
            chainintegrity*.filtered.log

      - name: Cleanup (docker compose down)
        if: always()
        run: docker compose -f compose/docker-compose-3blasters.yml down
  run-daemon-tests:
    runs-on: teranode-runner-16-core
    steps:
      - name: Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@f974e0c5942f8f37973c4cc395704165fbe629ba # v2
        with:
          theme: "dark"
          comment_on_pr: "false"

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Run Daemon Ready Tests
        run: |
          go clean -testcache
          go test -v $TEST_DIR
        env:
          GITHUB_ACTIONS: true
        continue-on-error: false

  chaostest:
    name: chaostest
    runs-on: teranode-runner-4-core
    steps:
      - name: Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@f974e0c5942f8f37973c4cc395704165fbe629ba # v2
        with:
          theme: "dark"
          comment_on_pr: "false"

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ vars.DOCKER_ORG }}
          password: ${{ secrets.DOCKER_ORG_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Start required services for chaos testing
        run: |
          cd compose
          docker compose -f docker-compose-ss.yml up -d postgres toxiproxy-postgres kafka-shared toxiproxy-kafka
          # Wait for PostgreSQL to be healthy
          timeout 60 bash -c 'until docker compose -f docker-compose-ss.yml ps postgres | grep -q "healthy"; do sleep 2; done'
          # Wait for toxiproxy services to be up and API responding (no healthcheck in minimal image)
          timeout 60 bash -c 'until curl -sf http://localhost:8474/version >/dev/null; do sleep 2; done'
          timeout 60 bash -c 'until curl -sf http://localhost:8475/version >/dev/null; do sleep 2; done'
          # Wait for Kafka to be ready (no healthcheck, just wait for it to be up)
          timeout 60 bash -c 'until docker compose -f docker-compose-ss.yml ps kafka-shared | grep -q "Up"; do sleep 2; done'
          sleep 10  # Extra wait for Kafka to be fully ready
        continue-on-error: false

      - name: Run Chaos Test Scenario 01 (Database Latency)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario01_DatabaseLatency 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-01-results.txt
        continue-on-error: false
        timeout-minutes: 5

      - name: Run Chaos Test Scenario 02 (Kafka Broker Failure)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario02_KafkaBrokerFailure 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-02-results.txt
        continue-on-error: false
        timeout-minutes: 5

      - name: Run Chaos Test Scenario 03 (Network Partition)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario03_NetworkPartition 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-03-results.txt
        continue-on-error: false
        timeout-minutes: 5

      - name: Upload chaostest results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: chaostest-results
          path: /tmp/teranode-test-results/chaostest-scenario-*.txt
          retention-days: 2
          if-no-files-found: warn

      - name: Cleanup chaos test services
        if: always()
        run: |
          cd compose
          docker compose -f docker-compose-ss.yml down -v

  chaostest2:
    name: chaostest2
    runs-on: teranode-runner-4-core
    steps:
      - name: Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@f974e0c5942f8f37973c4cc395704165fbe629ba # v2
        with:
          theme: "dark"
          comment_on_pr: "false"

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ vars.DOCKER_ORG }}
          password: ${{ secrets.DOCKER_ORG_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Start required services for chaos testing
        run: |
          cd compose
          docker compose -f docker-compose-ss.yml up -d postgres toxiproxy-postgres kafka-shared toxiproxy-kafka
          # Wait for PostgreSQL to be healthy
          timeout 60 bash -c 'until docker compose -f docker-compose-ss.yml ps postgres | grep -q "healthy"; do sleep 2; done'
          # Wait for toxiproxy services to be up and API responding (no healthcheck in minimal image)
          timeout 60 bash -c 'until curl -sf http://localhost:8474/version >/dev/null; do sleep 2; done'
          timeout 60 bash -c 'until curl -sf http://localhost:8475/version >/dev/null; do sleep 2; done'
          # Wait for Kafka to be ready (no healthcheck, just wait for it to be up)
          timeout 60 bash -c 'until docker compose -f docker-compose-ss.yml ps kafka-shared | grep -q "Up"; do sleep 2; done'
          sleep 10  # Extra wait for Kafka to be fully ready
        continue-on-error: false

      - name: Run Chaos Test Scenario 04A (Intermittent Connection Drops)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario04_IntermittentDrops 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-04a-results.txt
        continue-on-error: false
        timeout-minutes: 10

      - name: Run Chaos Test Scenario 04B (Cascading Effects)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario04_CascadingEffects 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-04b-results.txt
        continue-on-error: false
        timeout-minutes: 2

      - name: Run Chaos Test Scenario 04C (Load Under Failures)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario04_LoadUnderFailures 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-04c-results.txt
        continue-on-error: false
        timeout-minutes: 2

      - name: Run Chaos Test Scenario 05 (Bandwidth Constraints)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario05 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-05-results.txt
        continue-on-error: false
        timeout-minutes: 6

      - name: Run Chaos Test Scenario 06 (Slow Close Connections)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario06 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-06-results.txt
        continue-on-error: false
        timeout-minutes: 2

      - name: Run Chaos Test Scenario 07 (Combined Failures)
        run: |
          set -o pipefail
          mkdir -p /tmp/teranode-test-results
          go test -v ./test/chaos -run TestScenario07 2>&1 | tee /tmp/teranode-test-results/chaostest-scenario-07-results.txt
        continue-on-error: false
        timeout-minutes: 2

      - name: Upload chaostest results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: chaostest2-results
          path: /tmp/teranode-test-results/chaostest-scenario-*.txt
          retention-days: 2
          if-no-files-found: warn

      - name: Cleanup chaos test services
        if: always()
        run: |
          cd compose
          docker compose -f docker-compose-ss.yml down -v
